name: Dependency Check

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
  pull_request:
    paths:
      - 'pyproject.toml'
      - 'requirements*.txt'

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit
      
      - name: Run pip-audit
        run: |
          pip-audit --desc --fix --dry-run
        continue-on-error: true
      
      - name: Install package dependencies
        run: |
          pip install -e ".[all,dev,test]"
      
      - name: Audit installed packages
        run: |
          pip-audit --desc

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          comment-summary-in-pr: always

  update-dependencies:
    name: Check for Updates
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: Install pip-tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-tools
      
      - name: Check outdated packages
        run: |
          pip list --outdated
      
      - name: Create issue for outdated packages
        if: github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            const outdated = execSync('pip list --outdated --format=json').toString();
            const packages = JSON.parse(outdated);
            
            if (packages.length > 0) {
              const body = '## Outdated Dependencies\n\n' +
                packages.map(p => 
                  `- **${p.name}**: ${p.version} â†’ ${p.latest_version}`
                ).join('\n');
              
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Outdated dependencies detected',
                body: body,
                labels: ['dependencies']
              });
            }
